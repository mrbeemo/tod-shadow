<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dynamic Long Shadow</title>
<link rel="preconnect" href="https://rsms.me/">
<link rel="stylesheet" href="https://rsms.me/inter/inter.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
  /* ── Design tokens — pure black/white + opacity only ──────────── */
  :root {
    font-family: 'Inter', 'Inter var', sans-serif;
    --ui-fg:       rgba(0,0,0,0.85);
    --ui-muted:    rgba(0,0,0,0.38);
    --ui-chip-bg:  rgba(0,0,0,0.055);
    --ui-border:   rgba(0,0,0,0.09);
    --ui-surface:  rgba(255,255,255,0.78);
    --ui-btn-bg:   rgba(0,0,0,0.85);
    --ui-btn-fg:   rgba(255,255,255,1);
    --ui-btn2-bg:  rgba(0,0,0,0.07);
    --ui-btn2-fg:  rgba(0,0,0,0.85);
    --ui-track-hi: rgba(0,0,0,0.8);
    --ui-track-lo: rgba(0,0,0,0.12);
    --ui-thumb:    rgba(0,0,0,0.85);
    --ui-toggle-off: rgba(0,0,0,0.18);
    --ui-toggle-on:  rgba(0,0,0,0.82);
    --ui-toggle-knob: #fff;
    --ui-svg-stroke: rgba(0,0,0,0.12);
    --ui-svg-text:   rgba(0,0,0,0.28);
    --sun-dot: #e8a020;
  }

  /* Dark mode — inverts to white + opacity */
  body.dark {
    --ui-fg:       rgba(255,255,255,0.92);
    --ui-muted:    rgba(255,255,255,0.42);
    --ui-chip-bg:  rgba(255,255,255,0.08);
    --ui-border:   rgba(255,255,255,0.10);
    --ui-surface:  rgba(0,0,0,0.48);
    --ui-btn-bg:   rgba(255,255,255,0.92);
    --ui-btn-fg:   rgba(0,0,0,0.88);
    --ui-btn2-bg:  rgba(255,255,255,0.12);
    --ui-btn2-fg:  rgba(255,255,255,0.88);
    --ui-track-hi: rgba(255,255,255,0.85);
    --ui-track-lo: rgba(255,255,255,0.18);
    --ui-thumb:    rgba(255,255,255,0.9);
    --ui-toggle-off: rgba(255,255,255,0.22);
    --ui-toggle-on:  rgba(255,255,255,0.85);
    --ui-toggle-knob: rgba(0,0,0,0.85);
    --ui-svg-stroke: rgba(255,255,255,0.18);
    --ui-svg-text:   rgba(255,255,255,0.38);
    --sun-dot: #f0a830;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: #e8e0d4;
    color: var(--ui-fg);
    min-height: 100vh;
    display: grid;
    grid-template-rows: 1fr auto;
    align-items: stretch;
    transition: background 0.9s ease, color 0.4s ease;
    overflow: hidden;
  }

  /* ── Stage ───────────────────────────────────────── */
  .stage {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2.5rem 2rem 1.5rem;
    position: relative;
    overflow: visible;
  }

  /* The element the shadow is applied to */
  .tod-shadow {
    position: relative;
    cursor: pointer;
    flex-shrink: 0;
    /* Size is set by JS after image load; default is square */
    width: min(64vw, 68vh);
    height: min(64vw, 68vh);
    border-radius: 2px;
    /* Shadow transitions smoothly */
    transition: box-shadow 0.6s ease;
  }

  .tod-shadow.drag-over .drop-hint { border-color: rgba(0,0,0,0.4); }
  .tod-shadow.drag-over .photo-img { opacity: 0.35; }
  .tod-shadow.has-image .drop-hint { opacity: 0; }
  .tod-shadow.has-image.drag-over .drop-hint { opacity: 1; }

  .photo-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center center;
    display: block;
    border-radius: 2px;
    transition: opacity 0.2s;
    user-select: none;
    pointer-events: none;
  }

  .drop-hint {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    border-radius: 2px;
    border: 2px dashed rgba(0,0,0,0.18);
    opacity: 1;
    transition: opacity 0.2s, border-color 0.2s;
    pointer-events: none;
    background: transparent;
  }

  .drop-hint svg {
    width: 36px;
    height: 36px;
    color: var(--ui-fg);
    opacity: 0.35;
  }

  .drop-hint span {
    font-size: 0.78rem;
    font-weight: 500;
    letter-spacing: 0.02em;
    color: var(--ui-fg);
    opacity: 0.45;
  }

  #fileInput { display: none; }

  /* ── Controls panel ──────────────────────────────── */
  .controls {
    background: var(--ui-surface);
    backdrop-filter: blur(20px) saturate(1.2);
    -webkit-backdrop-filter: blur(20px) saturate(1.2);
    border-top: 1px solid var(--ui-border);
    padding: 1rem 1.75rem 1.25rem;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.85rem 2.5rem;
    transition: background 0.9s ease, border-color 0.4s ease;
  }

  .col-left, .col-right {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
  }

  /* Time display */
  .time-row {
    display: flex;
    align-items: baseline;
    gap: 0.45rem;
  }

  .time-display {
    font-size: 1.75rem;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
    letter-spacing: -0.02em;
    color: var(--ui-fg);
    line-height: 1;
    transition: color 0.4s ease;
  }

  .time-period {
    font-size: 0.68rem;
    font-weight: 600;
    letter-spacing: 0.09em;
    text-transform: uppercase;
    color: var(--ui-muted);
    transition: color 0.4s ease;
  }

  /* Sun arc */
  .sun-arc-wrap {
    position: relative;
    width: 100%;
  }

  .sun-arc {
    width: 100%;
    height: auto;
    aspect-ratio: 400 / 48;
    display: block;
    overflow: visible;
  }

  .sun-dot {
    position: absolute;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--sun-dot);
    transform: translate(-50%, -50%);
    pointer-events: none;
    transition: opacity 0.4s ease;
    box-shadow: 0 0 6px 1px rgba(232,160,32,0.4);
  }

  /* Slider */
  .slider-wrap {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
  }

  .slider-ticks {
    display: flex;
    justify-content: space-between;
    font-size: 0.56rem;
    font-weight: 500;
    color: var(--ui-muted);
    letter-spacing: 0.04em;
    padding: 0 1px;
    transition: color 0.4s ease;
  }

  input[type="range"] {
    -webkit-appearance: none;
    width: 100%;
    height: 2px;
    background: linear-gradient(
      to right,
      var(--ui-track-hi) var(--pct, 50%),
      var(--ui-track-lo) var(--pct, 50%)
    );
    border-radius: 2px;
    outline: none;
    cursor: pointer;
    transition: background 0.4s ease;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 15px;
    height: 15px;
    border-radius: 50%;
    background: var(--ui-thumb);
    cursor: pointer;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    transition: background 0.4s ease;
  }

  /* Chips */
  .chips {
    display: flex;
    gap: 0.5rem;
  }

  .chip {
    flex: 1;
    background: var(--ui-chip-bg);
    border-radius: 6px;
    padding: 0.42rem 0.6rem;
    transition: background 0.4s ease;
  }

  .chip-label {
    font-size: 0.54rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--ui-muted);
    display: block;
    margin-bottom: 0.18rem;
    transition: color 0.4s ease;
  }

  .chip-value {
    font-size: 0.76rem;
    font-weight: 500;
    font-variant-numeric: tabular-nums;
    color: var(--ui-fg);
    transition: color 0.4s ease;
  }

  /* Toggles */
  .toggles {
    display: flex;
    gap: 1.2rem;
    align-items: center;
  }

  .toggle-item {
    display: flex;
    align-items: center;
    gap: 0.45rem;
    cursor: pointer;
    user-select: none;
  }

  .toggle-item span {
    font-size: 0.66rem;
    font-weight: 500;
    color: var(--ui-fg);
    opacity: 0.72;
    transition: color 0.4s ease;
  }

  .toggle-item input[type="checkbox"] {
    -webkit-appearance: none;
    appearance: none;
    width: 28px;
    height: 16px;
    border-radius: 8px;
    background: var(--ui-toggle-off);
    cursor: pointer;
    position: relative;
    transition: background 0.2s ease;
    flex-shrink: 0;
  }

  .toggle-item input[type="checkbox"]:checked {
    background: var(--ui-toggle-on);
  }

  .toggle-item input[type="checkbox"]::after {
    content: '';
    position: absolute;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--ui-toggle-knob);
    top: 2px;
    left: 2px;
    transition: transform 0.2s ease, background 0.2s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.25);
  }

  .toggle-item input[type="checkbox"]:checked::after {
    transform: translateX(12px);
  }

  /* Buttons */
  .btn-row {
    display: flex;
    gap: 0.5rem;
  }

  .btn {
    flex: 1;
    padding: 0.52rem 0.7rem;
    border: none;
    border-radius: 6px;
    font-family: inherit;
    font-size: 0.63rem;
    font-weight: 600;
    letter-spacing: 0.07em;
    text-transform: uppercase;
    cursor: pointer;
    transition: opacity 0.15s, background 0.4s ease, color 0.4s ease;
    white-space: nowrap;
  }

  .btn:hover { opacity: 0.75; }

  .btn-primary {
    background: var(--ui-btn-bg);
    color: var(--ui-btn-fg);
  }


</style>
</head>
<body>

<div class="stage">
  <div class="tod-shadow" id="dropZone">
    <div class="drop-hint" id="dropHint">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/>
      </svg>
      <span>Drop an image here</span>
    </div>
    <img class="photo-img" id="photoImg" src="" alt="" style="display:none">
  </div>
  <input type="file" id="fileInput" accept="image/*">
</div>

<div class="controls" id="controlsPanel">

  <div class="col-left">
    <div class="time-row">
      <div class="time-display" id="timeDisplay">12:00</div>
      <div class="time-period" id="periodDisplay">noon</div>
    </div>

    <div class="sun-arc-wrap">
      <svg class="sun-arc" viewBox="0 0 400 48">
        <path d="M 10 44 Q 200 -10 390 44" fill="none" stroke="var(--ui-svg-stroke)" stroke-width="1.5"/>
        <line x1="0" y1="44" x2="400" y2="44" stroke="var(--ui-svg-stroke)" stroke-width="1"/>
        <text x="10" y="42" font-size="7" fill="var(--ui-svg-text)" font-family="Inter,sans-serif" font-weight="500">rise</text>
        <text x="355" y="42" font-size="7" fill="var(--ui-svg-text)" font-family="Inter,sans-serif" font-weight="500">set</text>
      </svg>
      <div class="sun-dot" id="sunDot"></div>
    </div>

    <div class="slider-wrap">
      <input type="range" id="timeSlider" min="0" max="1439" value="720" step="1">
      <div class="slider-ticks">
        <span>12a</span><span>3a</span><span>6a</span><span>9a</span>
        <span>12p</span><span>3p</span><span>6p</span><span>9p</span><span>12a</span>
      </div>
    </div>
  </div>

  <div class="col-right">
    <div class="chips">
      <div class="chip">
        <span class="chip-label">Angle</span>
        <span class="chip-value" id="chipAngle">180°</span>
      </div>
      <div class="chip">
        <span class="chip-label">Sun</span>
        <span class="chip-value" id="chipSun">Overhead</span>
      </div>
      <div class="chip">
        <span class="chip-label">Length</span>
        <span class="chip-value" id="chipLen">Medium</span>
      </div>
    </div>

    <div class="toggles">
      <label class="toggle-item">
        <input type="checkbox" id="toggleBg" checked>
        <span>Dynamic background</span>
      </label>
    </div>

    <div class="btn-row">
      <button class="btn btn-primary"   id="btnNow">Current time</button>
      <button class="btn btn-secondary" id="btnDownload">Download files</button>
    </div>
  </div>

</div>


<script>
// ─────────────────────────────────────────────────────────────────
// .tod-shadow — Time of Day Shadow
// Pure black + opacity layers via Josh Comeau's exponential method.
// ─────────────────────────────────────────────────────────────────

function buildLayeredShadow(dx, dy, maxLen) {
  const n = 7, total = Math.pow(2, n) - 1;
  const layers = [`0px 4px 8px rgba(0,0,0,0.42)`];
  for (let i = 0; i < n; i++) {
    const d = maxLen * (Math.pow(2, i) / total);
    const x = (dx * d).toFixed(2);
    const y = (dy * d).toFixed(2);
    const b = Math.max(1, d).toFixed(2);
    layers.push(`${x}px ${y}px ${b}px rgba(0,0,0,0.24)`);
  }
  return layers.join(', ');
}

function getShadowParams(minutes) {
  const hour = minutes / 60;
  const isDaytime = hour >= 6 && hour <= 18;
  const t = Math.max(0, Math.min(1, (hour - 6) / 12));
  if (!isDaytime) return { dx: 0, dy: 1, len: 10, isDaytime: false, t: 0.5 };
  const elev = Math.sin(t * Math.PI);
  const az   = (t - 0.5) * Math.PI;
  return {
    dx: -Math.sin(az),
    dy: Math.max(0.15, 1 - Math.abs(az) * 0.4),
    len: 30 + 120 * (1 - elev),
    isDaytime: true, t, elev
  };
}

// ── Time display ──────────────────────────────────────────────────
function formatTime(minutes) {
  const h = Math.floor(minutes / 60) % 24;
  const m = minutes % 60;
  const displayH = h % 12 === 0 ? 12 : h % 12;
  return {
    label:  `${displayH}:${String(m).padStart(2, '0')}`,
    period: h === 12 ? 'noon' : h === 0 ? 'midnight' : h < 12 ? 'AM' : 'PM'
  };
}

// ── Sun arc bezier ────────────────────────────────────────────────
function sunArcPos(t) {
  const P0={x:10,y:44}, P1={x:200,y:-10}, P2={x:390,y:44};
  return {
    cx: (1-t)*(1-t)*P0.x + 2*(1-t)*t*P1.x + t*t*P2.x,
    cy: (1-t)*(1-t)*P0.y + 2*(1-t)*t*P1.y + t*t*P2.y,
  };
}

// ── Background color ──────────────────────────────────────────────
function getBgColor(hour) {
  const stops = [
    { h:0,  bg:'#161220' },
    { h:5,  bg:'#2a1c2c' },
    { h:6,  bg:'#a85e24' },
    { h:8,  bg:'#d6c8b2' },
    { h:12, bg:'#e8e0d4' },
    { h:16, bg:'#dbd3c4' },
    { h:18, bg:'#a85e24' },
    { h:20, bg:'#28122c' },
    { h:24, bg:'#161220' },
  ];
  let lo = stops[0], hi = stops[stops.length-1];
  for (let i = 0; i < stops.length-1; i++) {
    if (hour >= stops[i].h && hour <= stops[i+1].h) { lo=stops[i]; hi=stops[i+1]; break; }
  }
  const t = hi.h===lo.h ? 0 : (hour-lo.h)/(hi.h-lo.h);
  const px = s => [parseInt(s.slice(1,3),16),parseInt(s.slice(3,5),16),parseInt(s.slice(5,7),16)];
  const [ar,ag,ab]=px(lo.bg),[br,bg,bb]=px(hi.bg);
  return `rgb(${Math.round(ar+(br-ar)*t)},${Math.round(ag+(bg-ag)*t)},${Math.round(ab+(bb-ab)*t)})`;
}

// ── Dark mode threshold ───────────────────────────────────────────
function isDark(hour) { return hour < 7.5 || hour > 17.5; }

// ── State ─────────────────────────────────────────────────────────
let dynamicBg = true;

// ── Main update ───────────────────────────────────────────────────
function update(minutes) {
  const p = getShadowParams(minutes);
  const hour = minutes / 60;
  const { label, period } = formatTime(minutes);

  // Shadow on .tod-shadow element
  document.getElementById('dropZone').style.boxShadow =
    buildLayeredShadow(p.dx, p.dy, p.len);

  // Time
  document.getElementById('timeDisplay').textContent = label;
  document.getElementById('periodDisplay').textContent = period;

  // Chips
  const angleDeg = Math.round(Math.atan2(p.dx, p.dy) * 180 / Math.PI);
  document.getElementById('chipAngle').textContent = `${((angleDeg%360)+360)%360}°`;
  document.getElementById('chipLen').textContent =
    p.len < 50 ? 'Short' : p.len < 100 ? 'Medium' : 'Long';
  let sunLabel = 'Below horizon';
  if (p.isDaytime) {
    if      (p.t < 0.1)  sunLabel = 'Low E';
    else if (p.t < 0.3)  sunLabel = 'Rising';
    else if (p.t < 0.5)  sunLabel = 'Morning';
    else if (p.t < 0.6)  sunLabel = 'Noon';
    else if (p.t < 0.75) sunLabel = 'Afternoon';
    else if (p.t < 0.9)  sunLabel = 'Setting';
    else                  sunLabel = 'Low W';
  }
  document.getElementById('chipSun').textContent = sunLabel;

  // Sun dot
  const dot = document.getElementById('sunDot');
  if (p.isDaytime) {
    const pos = sunArcPos(p.t);
    dot.style.left    = (pos.cx / 400 * 100).toFixed(3) + '%';
    dot.style.top     = (pos.cy / 48  * 100).toFixed(3) + '%';
    dot.style.opacity = '1';
  } else {
    dot.style.opacity = '0';
  }

  // Dark/light mode toggle for UI
  if (isDark(hour)) {
    document.body.classList.add('dark');
  } else {
    document.body.classList.remove('dark');
  }

  // Background
  if (dynamicBg) {
    document.body.style.background = getBgColor(hour);
  }

  // Slider fill
  document.getElementById('timeSlider')
    .style.setProperty('--pct', (minutes / 1439 * 100).toFixed(1) + '%');
}

// ── Background toggle ─────────────────────────────────────────────
document.getElementById('toggleBg').addEventListener('change', function() {
  dynamicBg = this.checked;
  if (!dynamicBg) {
    document.body.style.background = '#ffffff';
    document.body.classList.remove('dark');
  } else {
    update(parseInt(document.getElementById('timeSlider').value));
  }
});

// ── Drag and drop + file upload ───────────────────────────────────
const dropZone = document.getElementById('dropZone');
const photoImg = document.getElementById('photoImg');
const fileInput = document.getElementById('fileInput');

function loadImageFile(file) {
  if (!file || !file.type.startsWith('image/')) return;
  const reader = new FileReader();
  reader.onload = e => {
    const tmp = new Image();
    tmp.onload = () => {
      // Resize drop-zone to match the image's natural aspect ratio,
      // constrained to 64vw × 68vh so it never overflows the stage.
      const ratio   = tmp.naturalWidth / tmp.naturalHeight;
      const maxW    = window.innerWidth  * 0.64;
      const maxH    = window.innerHeight * 0.68;
      let w = maxW, h = maxW / ratio;
      if (h > maxH) { h = maxH; w = maxH * ratio; }
      dropZone.style.width  = `${w}px`;
      dropZone.style.height = `${h}px`;
      // Re-apply shadow after resize so it matches new dimensions
      update(parseInt(document.getElementById('timeSlider').value));
    };
    tmp.src = e.target.result;
    photoImg.src = e.target.result;
    photoImg.style.display = 'block';
    photoImg.style.objectFit = 'fill';
    dropZone.classList.add('has-image');
  };
  reader.readAsDataURL(file);
}

dropZone.addEventListener('dragenter', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragover',  e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('drag-over');
  loadImageFile(e.dataTransfer.files[0]);
});
dropZone.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', e => loadImageFile(e.target.files[0]));

// ── Current time button ───────────────────────────────────────────
document.getElementById('btnNow').addEventListener('click', e => {
  e.stopPropagation();
  const now = new Date();
  const minutes = now.getHours() * 60 + now.getMinutes();
  document.getElementById('timeSlider').value = minutes;
  update(minutes);
});

// ── Slider ────────────────────────────────────────────────────────
document.getElementById('timeSlider').addEventListener('input', function() {
  update(parseInt(this.value));
});

// ── Download zip ──────────────────────────────────────────────────
document.getElementById('btnDownload').addEventListener('click', e => {
  e.stopPropagation();

  const css =
`.tod-shadow {
  /* box-shadow is applied dynamically by tod-shadow.js */
  transition: box-shadow 0.6s ease;
}`;

  const js =
`/* tod-shadow.js — Time of Day Shadow
 * Add class="tod-shadow" to any element, then include this script.
 * Layered box-shadow using pure black + opacity — works on any background.
 * Based on Josh Comeau's exponential shadow layering technique.
 * mrbrianmorris.com */

(function () {
  function buildTodShadow(dx, dy, len) {
    var n = 7, total = Math.pow(2, n) - 1;
    var layers = ['0px 4px 8px rgba(0,0,0,0.42)'];
    for (var i = 0; i < n; i++) {
      var d = len * (Math.pow(2, i) / total);
      var x = (dx * d).toFixed(2);
      var y = (dy * d).toFixed(2);
      var b = Math.max(1, d).toFixed(2);
      layers.push(x + 'px ' + y + 'px ' + b + 'px rgba(0,0,0,0.24)');
    }
    return layers.join(', ');
  }

  function getTodParams() {
    var now  = new Date();
    var hour = now.getHours() + now.getMinutes() / 60;
    if (hour < 6 || hour > 18) return { dx: 0, dy: 1, len: 10 };
    var t    = (hour - 6) / 12;
    var elev = Math.sin(t * Math.PI);
    var az   = (t - 0.5) * Math.PI;
    return {
      dx:  -Math.sin(az),
      dy:  Math.max(0.15, 1 - Math.abs(az) * 0.4),
      len: 30 + 120 * (1 - elev)
    };
  }

  function updateTodShadows() {
    var p = getTodParams();
    var shadow = buildTodShadow(p.dx, p.dy, p.len);
    document.querySelectorAll('.tod-shadow')
      .forEach(function(el) { el.style.boxShadow = shadow; });
  }

  updateTodShadows();
  setInterval(updateTodShadows, 60000);
})();`;

  const zip = new JSZip();
  zip.file('tod-shadow.css', css);
  zip.file('tod-shadow.js',  js);
  zip.generateAsync({ type: 'blob' }).then(blob => {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'tod-shadows.zip';
    a.click();
    URL.revokeObjectURL(a.href);
  });
});

// ── Init ──────────────────────────────────────────────────────────
const now = new Date();
const initMin = now.getHours() * 60 + now.getMinutes();
document.getElementById('timeSlider').value = initMin;
update(initMin);
</script>

</body>
</html>
